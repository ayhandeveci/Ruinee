<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>İflas Ağacı (Discrete-Time) — ψ(t;u)</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#94a3b8;--line:#334155;--ok:#10b981;--bad:#ef4444}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid #1f2937;background:#0b1220}
  h1{margin:0;font-size:18px}
  .wrap{display:grid;grid-template-columns:360px 1fr;min-height:100vh}
  .left{padding:14px;border-right:1px solid #1f2937;background:var(--panel)}
  .right{padding:16px}
  fieldset{border:1px solid #1f2937;border-radius:10px;padding:10px 12px;margin:0 0 12px}
  legend{color:var(--muted);padding:0 6px}
  label{display:block;margin:6px 0 4px}
  input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid #253047;background:#0b1220;color:var(--ink)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{background:#1f2937;color:#e5e7eb;border:1px solid #334155;border-radius:8px;padding:8px 10px;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .btn.primary{background:#2563eb;border-color:#1d4ed8}
  .prob-grid{display:grid;grid-template-columns:60px 1fr 70px;gap:6px;align-items:center;margin-top:6px}
  .muted{color:var(--muted);font-size:13px}
  .sum{margin-top:6px;font:13px/1 monospace}
  .sum.ok{color:var(--ok)} .sum.bad{color:var(--bad)}
  .legend{display:flex;gap:10px;align-items:center;margin:8px 0}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.root{background:#60a5fa}.dot.child{background:#34d399}.dot.leaf{background:#a78bfa}.dot.ruin{background:#ef4444}
  svg{width:100%;height:560px;background:#0b1220;border:1px solid #253047;border-radius:10px}
  .node{paint-order:stroke;stroke:#0008;stroke-width:1.5px}
  .lab{font:12px sans-serif;fill:#d1d5db}
  .edge{stroke:#475569;stroke-width:1.5px}
  .edgelab{font:11px sans-serif;fill:#9ca3af}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#064e3b}
</style>
</head>
<body>
<header><h1>İflas Ağacı — ψ(t;u) (Discrete-Time, tek adım dallanma)</h1></header>
<div class="wrap">
  <section class="left">
    <fieldset>
      <legend>Parametreler</legend>
      <div class="row">
        <div><label>Başlangıç sermayesi <b>u</b></label><input id="u0" type="number" value="2" min="0" step="1"></div>
        <div><label>Ufuk (dönem) <b>t</b></label><input id="tH" type="number" value="2" min="1" step="1"></div>
      </div>
      <div class="muted" style="margin-top:6px">Prim her dönemde +1. Güncelleme: <code>u ← u + 1 − j</code></div>
    </fieldset>

    <fieldset>
      <legend>Hasar dağılımı f<sub>X</sub>(j)</legend>
      <div id="rows"></div>
      <div class="sum" id="psum"></div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn" id="add">+ Sonuç</button>
        <button class="btn" id="rem">− Sonuç</button>
        <button class="btn" id="norm">Normalize</button>
        <button class="btn" id="ex">Example 5.3</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>Çalıştır</legend>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" id="draw">Ağacı Çiz</button>
        <button class="btn" id="calc">ψ(t;u) Hesapla</button>
      </div>
      <div id="res" style="margin-top:8px" class="muted">Hazır.</div>
      <div class="legend">
        <div class="dot root"></div><span class="muted">Kök (u,t)</span>
        <div class="dot child"></div><span class="muted">Güncellenmiş u</span>
        <div class="dot leaf"></div><span class="muted">ψ(t−1;u+1−j)</span>
        <div class="dot ruin"></div><span class="muted">Doğrudan iflas ψ(1;u)</span>
      </div>
    </fieldset>
  </section>

  <section class="right">
    <svg id="svg" viewBox="0 0 900 560" preserveAspectRatio="xMidYMid meet"></svg>
  </section>
</div>

<script>
/* ---------- state ---------- */
let probs = [0.5,0.2,0.2,0.1]; // Example 5.3 default

/* ---------- UI for probs ---------- */
const rows = document.getElementById('rows');
const psum = document.getElementById('psum');

function renderRows(){
  rows.innerHTML='';
  probs.forEach((p,j)=>{
    const line=document.createElement('div');
    line.className='prob-grid';
    line.innerHTML=`
      <div class="muted">j=${j}</div>
      <input type="number" step="0.001" min="0" max="1" value="${p}" data-j="${j}">
      <div class="muted">f<sub>X</sub>(${j})</div>`;
    rows.appendChild(line);
  });
  rows.querySelectorAll('input').forEach(inp=>{
    inp.oninput = e=>{
      const j=+e.target.dataset.j, v=+e.target.value;
      probs[j]=isFinite(v)&&v>=0?v:0; updateSum();
    };
  });
  updateSum();
}
function updateSum(){
  const s = probs.reduce((a,b)=>a+b,0);
  psum.textContent = `Toplam = ${s.toFixed(3)}`;
  psum.className = 'sum ' + (Math.abs(s-1)<=1e-9?'ok':'bad');
}
document.getElementById('add').onclick=()=>{probs.push(0);renderRows();};
document.getElementById('rem').onclick=()=>{if(probs.length>1){probs.pop();renderRows();}};
document.getElementById('norm').onclick=()=>{const s=probs.reduce((a,b)=>a+b,0); if(s>0) probs=probs.map(p=>p/s); else probs=[1]; renderRows();};
document.getElementById('ex').onclick=()=>{probs=[0.5,0.2,0.2,0.1]; document.getElementById('u0').value=2; document.getElementById('tH').value=2; renderRows();};

/* ---------- math: ψ(t;u) ---------- */
function tailSX(u){ // P(X>u)
  let s=0; for(let j=0;j<=u && j<probs.length;j++) s+=probs[j];
  return Math.max(0,1-s);
}
const memo = new Map();
function key(t,u){ return t+'|'+u; }
function psi(t,u){
  if(t<=0) return 0;
  if(t===1) return tailSX(u);
  const k=key(t,u); if(memo.has(k)) return memo.get(k);
  const M = probs.length-1, cap = Math.min(u,M);
  let sum = psi(1,u);
  for(let j=0;j<=cap;j++) sum += probs[j]*psi(t-1, u+1-j);
  memo.set(k,sum); return sum;
}

/* ---------- draw ---------- */
const svg = document.getElementById('svg');
function S(tag,attrs={},text=''){ const el=document.createElementNS('http://www.w3.org/2000/svg',tag);
  Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k,v)); if(text) el.textContent=text; return el; }
function drawTree(){
  svg.innerHTML='';
  memo.clear();
  const u0 = Math.max(0, Math.floor(+document.getElementById('u0').value||0));
  const tH = Math.max(1, Math.floor(+document.getElementById('tH').value||1));
  const W=900,H=560, cx=W/2, cy=90;

  // root
  svg.appendChild(S('circle',{cx,cy,r:18,fill:'#60a5fa',class:'node'}));
  svg.appendChild(S('text',{x:cx,y:cy-26,class:'lab','text-anchor':'middle'}, `u=${u0}, t=${tH}`));

  // direct ruin leaf
  const pruin = psi(1,u0);
  const rx = cx, ry = H-70;
  svg.appendChild(S('line',{x1:cx,y1:cy+18,x2:rx,y2:ry-18,class:'edge'}));
  svg.appendChild(S('text',{x:(cx+rx)/2+6,y:(cy+ry)/2,class:'edgelab'}, `P(X>u)=ψ(1;${u0})=${pruin.toFixed(3)}`));
  svg.appendChild(S('circle',{cx:rx,cy:ry,r:18,fill:'#ef4444',class:'node'}));
  svg.appendChild(S('text',{x:rx,y:ry+32,class:'lab','text-anchor':'middle'}, 'Doğrudan İFLAS'));

  // children for j=0..min(u,M)
  const M = probs.length-1, cap = Math.min(u0,M);
  if(cap>=0){
    const spread = Math.max(280, 90*cap);
    for(let k=0;k<=cap;k++){
      const frac = cap>0? (k/cap) : 0.5;
      const x = cx - spread/2 + frac*spread;
      const y = cy + 130;

      // edge root->child
      svg.appendChild(S('line',{x1:cx,y1:cy+18,x2:x,y2:y-18,class:'edge'}));
      svg.appendChild(S('text',{x:(cx+x)/2,y:(cy+y)/2-4,class:'edgelab','text-anchor':'middle'}, `j=${k}  (f=${probs[k].toFixed(3)})`));

      // child node (updated surplus)
      svg.appendChild(S('circle',{cx:x,cy:y,r:16,fill:'#34d399',class:'node'}));
      const unew = u0 + 1 - k;
      svg.appendChild(S('text',{x:x,y:y-24,class:'lab','text-anchor':'middle'}, `u'=${unew}`));

      // leaf showing ψ(t-1; u')
      const lx = x, ly = y + 120;
      svg.appendChild(S('line',{x1:x,y1:y+16,x2:lx,y2:ly-16,class:'edge'}));
      svg.appendChild(S('circle',{cx:lx,cy:ly,r:14,fill:'#a78bfa',class:'node'}));
      const val = psi(Math.max(1,tH-1), unew);
      svg.appendChild(S('text',{x:lx,y:ly+30,class:'lab','text-anchor':'middle'}, `ψ(${Math.max(1,tH-1)};${unew})=${val.toFixed(3)}`));
    }
  }

  // footer total
  const total = psi(tH,u0).toFixed(6);
  const pill = S('text',{x:W-16,y:24,'text-anchor':'end',class:'lab'},
    `Toplam ψ(${tH};${u0}) = ${total}`);
  svg.appendChild(pill);
}

document.getElementById('draw').onclick = drawTree;
document.getElementById('calc').onclick = ()=>{
  memo.clear();
  const u0 = Math.max(0, Math.floor(+document.getElementById('u0').value||0));
  const tH = Math.max(1, Math.floor(+document.getElementById('tH').value||1));
  const v = psi(tH,u0);
  document.getElementById('res').innerHTML =
    `Sonuç: <span class="pill">ψ(${tH};${u0}) = ${v.toFixed(6)}</span>`;
};

renderRows();
drawTree();
</script>
</body>
</html>
